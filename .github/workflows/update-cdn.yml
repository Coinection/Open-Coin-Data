name: Update Open Coin Data CDN

on:
  push:
    branches: ["main"]
    paths-ignore:
      - ".github/**"
  workflow_dispatch:

jobs:
  update-seed:
    name: Update Open Coin Data CDN
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Open Coin Data
        uses: actions/checkout@v4
        with:
          repository: coinection/open-coin-data
          path: ocd
          fetch-depth: 0

      - name: Checkout Coinection Scripts
        uses: actions/checkout@v4
        with:
          repository: coinection/coinection-scripts
          path: scripts
          token: ${{ secrets.ACCESS_TOKEN }}

      - name: Determine if any images were updated
        id: check-images
        run: |
          cd ./ocd

          # Check if the last commit modified any files in Images folders
          git diff-tree --name-only -r HEAD^ HEAD | grep "Images" > images.txt || true

          # Remove duplicates and empty lines
          sort -u images.txt | sed '/^$/d' > images_temp.txt
          mv images_temp.txt images.txt

          if [ -s images.txt ]; then
            echo "Image files were updated:"
            cat images.txt
            echo "has_images=true" >> $GITHUB_OUTPUT
          else
            echo "No image files were updated."
            echo "has_images=false" >> $GITHUB_OUTPUT
          fi

      - name: Run CDN Update Script
        if: steps.check-images.outputs.has_images == 'true'
        run: |
          cd ./scripts
          npm install
          npm run update-cdn-images
        env:
          AWS_ACCESS_KEY: "${{ secrets.AWS_ACCESS_KEY_ID }}"
          AWS_SECRET_KEY: "${{ secrets.AWS_SECRET_ACCESS_KEY }}"   
